<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Longitudinal Motif Detection • ASAP</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Longitudinal Motif Detection">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">ASAP</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Longitudinal Motif Detection</h1>
            
      

      <div class="d-none name"><code>longitudinal_motif_detection.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette demonstrates how to detect and analyze song motifs
across <strong>longitudinal recordings</strong> using SAP objects and
optimized template parameters.</p>
<p><strong>Prerequisites</strong>: Before reading this vignette, we
recommend completing:</p>
<ul>
<li>
<a href="single_wav_analysis.html">Overview: Basic Audio
Analysis</a> - Core ASAP functions</li>
<li>
<a href="motif_detection.html">Motif Detection</a> - Template
optimization workflow</li>
<li>
<a href="construct_sap_object.html">Constructing SAP Object</a> -
SAP object creation</li>
</ul>
</div>
<div class="section level2">
<h2 id="overview">Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>The longitudinal motif detection workflow applies the template
parameters you optimized on a single recording (see <a href="motif_detection.html">Motif Detection</a>) across all recordings
in a SAP object.</p>
<div class="float">
<img src="figures/longitudinal_pipeline.png" style="width:60.0%" alt="Longitudinal Motif Detection Pipeline"><div class="figcaption">Longitudinal Motif Detection Pipeline</div>
</div>
</div>
<div class="section level2">
<h2 id="complete-pipeline">Complete Pipeline<a class="anchor" aria-label="anchor" href="#complete-pipeline"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lxiao06.github.io/ASAP/">ASAP</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load or create SAP object</span></span>
<span><span class="va">sap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/create_sap_object.html">create_sap_object</a></span><span class="op">(</span></span>
<span>  base_path <span class="op">=</span> <span class="st">"/path/to/recordings"</span>,</span>
<span>  subfolders_to_include <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"190"</span>, <span class="st">"201"</span>, <span class="st">"203"</span><span class="op">)</span>,</span>
<span>  labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"BL"</span>, <span class="st">"Post"</span>, <span class="st">"Rec"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run the complete motif detection pipeline</span></span>
<span><span class="va">sap</span> <span class="op">&lt;-</span> <span class="va">sap</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/create_audio_clip.html">create_audio_clip</a></span><span class="op">(</span>indices <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                    start_time <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                    end_time <span class="op">=</span> <span class="fl">2.5</span>, </span>
<span>                    clip_names <span class="op">=</span> <span class="st">"motif_ref"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/create_template.html">create_template</a></span><span class="op">(</span>template_name <span class="op">=</span> <span class="st">"syllable_d"</span>, </span>
<span>                  clip_name <span class="op">=</span> <span class="st">"motif_ref"</span>,</span>
<span>                  start_time <span class="op">=</span> <span class="fl">0.72</span>, </span>
<span>                  end_time <span class="op">=</span> <span class="fl">0.84</span>,</span>
<span>                  freq_min <span class="op">=</span> <span class="fl">1</span>, </span>
<span>                  freq_max <span class="op">=</span> <span class="fl">10</span>, </span>
<span>                  threshold <span class="op">=</span> <span class="fl">0.5</span>, </span>
<span>                  write_template <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/detect_template.html">detect_template</a></span><span class="op">(</span>template_name <span class="op">=</span> <span class="st">"syllable_d"</span>,</span>
<span>                  threshold <span class="op">=</span> <span class="fl">0.5</span>,</span>
<span>                  proximity_window <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/find_motif.html">find_motif</a></span><span class="op">(</span>template_name <span class="op">=</span> <span class="st">"syllable_d"</span>, </span>
<span>             pre_time <span class="op">=</span> <span class="fl">0.7</span>, </span>
<span>             lag_time <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="understanding-sap-object-behavior">Understanding SAP Object Behavior<a class="anchor" aria-label="anchor" href="#understanding-sap-object-behavior"></a>
</h3>
<p><strong>1. Metadata-Based Lazy Loading</strong></p>
<p>After creating the SAP object, you have a metadata index (stored in
<code>sap$metadata</code>) that references all audio files by their
paths and timestamps. The actual WAV file data is <strong>not loaded
into memory</strong>—files are read on-demand during analysis. This
means:</p>
<ul>
<li>The SAP object remains lightweight even with thousands of
recordings</li>
<li>
<strong>All subsequent pipeline steps require the original WAV files
to be accessible</strong> at their original paths</li>
<li>If you move or delete the audio files, the pipeline will fail</li>
</ul>
<p><strong>2. Centralized Result Storage</strong></p>
<p>The SAP object stores all analysis results in a structured format,
making it easy to access detection outcomes:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Access template detection results</span></span>
<span><span class="va">sap</span><span class="op">$</span><span class="va">templates</span><span class="op">$</span><span class="va">template_matches</span><span class="op">[[</span><span class="st">"syllable_d"</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Access extracted motif boundaries (onset/offset timestamps)</span></span>
<span><span class="va">sap</span><span class="op">$</span><span class="va">motifs</span>  <span class="co"># Data frame with start_time, end_time for each detected motif</span></span>
<span></span>
<span><span class="co"># Access spectral features (if analyze_spectral() was run)</span></span>
<span><span class="va">sap</span><span class="op">$</span><span class="va">features</span><span class="op">$</span><span class="va">motif</span><span class="op">$</span><span class="va">spectral_feature</span></span></code></pre></div>
<p><strong>3. Optional Template Detection Visualizations</strong></p>
<p>If you set <code>save_plot = TRUE</code> in
<code><a href="../reference/detect_template.html">detect_template()</a></code>, spectrogram images of template
detections are saved to a local directory (typically
<code>templates/</code> within your base path). These images are
<strong>not stored in the SAP object</strong> but can be useful for
quality control and manual inspection of detection accuracy.</p>
<p><strong>Example output:</strong></p>
<pre><code>=== Starting Template Detection ===

Processing 312 files for day 190 using 7 cores.
Processed files in day 190. Total detections: 1247

Processing 285 files for day 201 using 7 cores.
Processed files in day 201. Total detections: 1089

Processing 250 files for day 203 using 7 cores.
Processed files in day 203. Total detections: 956

Total detections across all days: 3292
Access detection results via: sap$templates$template_matches[["syllable_d"]]</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="visualizing-results">Visualizing Results<a class="anchor" aria-label="anchor" href="#visualizing-results"></a>
</h2>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Visualize sample motifs from each time point</span></span>
<span><span class="fu"><a href="../reference/visualize_segments.html">visualize_segments</a></span><span class="op">(</span><span class="va">sap</span>, </span>
<span>                   segment_type <span class="op">=</span> <span class="st">"motifs"</span>, </span>
<span>                   n_samples <span class="op">=</span> <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figures/longitudinal_segments.png" class="r-plt" alt="Sample motif spectrograms across developmental time points." width="100%"><p class="caption">
Sample motif spectrograms across developmental time points.
</p>
</div>
<div class="section level3">
<h3 id="amplitude-envelope-heatmap">Amplitude Envelope Heatmap<a class="anchor" aria-label="anchor" href="#amplitude-envelope-heatmap"></a>
</h3>
<p>Amplitude envelope heatmaps visualize the temporal structure of
detected motifs. <strong>The <code>balanced</code> argument</strong>
ensures equal representation across time points (e.g., same number of
motifs from each developmental stage), which improves statistical
comparisons.</p>
<p>However, <strong>motif durations can vary</strong> across
renditions—some motifs may be shorter than others due to natural
variability or developmental changes. This duration variability can make
heatmaps appear misaligned or noisy, with vertical bands appearing
blurred or offset. To address this issue, we can extract acoustic
features from individual motifs, cluster them based on these features
within each developmental stage, and order them by their latent feature
structure (see “Ordered Heatmap” section below).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create amplitude envelope heatmap with balanced sampling</span></span>
<span><span class="fu"><a href="../reference/plot_heatmap.html">plot_heatmap</a></span><span class="op">(</span><span class="va">sap</span>, balanced <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="figures/longitudinal_heatmap.png" class="r-plt" alt="Amplitude envelope heatmap showing temporal structure across time points." width="100%"><p class="caption">
Amplitude envelope heatmap showing temporal structure across time
points.
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="feature-extraction-and-analysis">Feature Extraction and Analysis<a class="anchor" aria-label="anchor" href="#feature-extraction-and-analysis"></a>
</h2>
<p>Extracting spectral features allows you to quantify motif acoustic
properties and identify clusters of similar motifs. This is particularly
useful for:</p>
<ul>
<li>
<strong>Grouping motifs by acoustic similarity</strong> rather than
just temporal alignment</li>
<li>
<strong>Identifying developmental changes</strong> in song
structure</li>
<li>
<strong>Reducing noise</strong> in downstream visualizations</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract spectral features (frequency, entropy, duration, etc.)</span></span>
<span><span class="va">sap</span> <span class="op">&lt;-</span> <span class="va">sap</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/analyze_spectral.html">analyze_spectral</a></span><span class="op">(</span>balanced <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/find_clusters.html">find_clusters</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span>              <span class="co"># Group acoustically similar motifs</span></span>
<span>  <span class="fu"><a href="../reference/run_umap.html">run_umap</a></span><span class="op">(</span><span class="op">)</span>                       <span class="co"># Dimensionality reduction for visualization</span></span>
<span></span>
<span><span class="co"># Visualize UMAP by time point</span></span>
<span><span class="fu"><a href="../reference/plot_umap.html">plot_umap</a></span><span class="op">(</span><span class="va">sap</span>, split.by <span class="op">=</span> <span class="st">"label"</span><span class="op">)</span></span></code></pre></div>
<p><strong>Results interpretation:</strong></p>
<ul>
<li>
<code><a href="../reference/analyze_spectral.html">analyze_spectral()</a></code> extracts ~30 acoustic features per
motif (mean frequency, entropy, duration, spectral slope, etc.) and
stores them in <code>sap$features$motif$spectral_feature</code>
</li>
<li>
<code><a href="../reference/find_clusters.html">find_clusters()</a></code> uses hierarchical clustering to group
motifs by acoustic similarity, adding a <code>cluster</code> column to
the feature data</li>
<li>
<code><a href="../reference/run_umap.html">run_umap()</a></code> reduces high-dimensional feature space to 2D
for visualization, storing coordinates in
<code>sap$umap$motif</code>
</li>
</ul>
<div class="figure">
<img src="figures/longitudinal_umap.png" class="r-plt" alt="UMAP visualization of motif features colored by developmental time point." width="100%"><p class="caption">
UMAP visualization of motif features colored by developmental time
point.
</p>
</div>
<div class="section level3">
<h3 id="ordered-heatmap-by-acoustic-similarity">Ordered Heatmap by Acoustic Similarity<a class="anchor" aria-label="anchor" href="#ordered-heatmap-by-acoustic-similarity"></a>
</h3>
<p>As mentioned above, ordering motifs by acoustic similarity creates a
<strong>cleaner, more organized heatmap</strong> that addresses the
visual noise from duration variability. After extracting features and
clustering, motifs are ordered by their cluster membership and latent
feature structure rather than chronological order:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create heatmap ordered by cluster membership</span></span>
<span><span class="fu"><a href="../reference/plot_heatmap.html">plot_heatmap</a></span><span class="op">(</span><span class="va">sap</span>, balanced <span class="op">=</span> <span class="cn">TRUE</span>, ordered <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><strong>Why this helps:</strong></p>
<ul>
<li>Motifs with similar acoustic properties are grouped together</li>
<li>Vertical bands align better because acoustically similar motifs tend
to have similar durations</li>
<li>Developmental patterns become more apparent when organized by
acoustic structure</li>
<li>Reduces visual noise from duration variability</li>
</ul>
<div class="figure">
<img src="figures/longitudinal_heatmap_ordered.png" class="r-plt" alt="Ordered amplitude envelope heatmap grouped by acoustic similarity." width="100%"><p class="caption">
Ordered amplitude envelope heatmap grouped by acoustic similarity.
</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="key-parameters-for-longitudinal-analysis">Key Parameters for Longitudinal Analysis<a class="anchor" aria-label="anchor" href="#key-parameters-for-longitudinal-analysis"></a>
</h2>
<table class="table">
<colgroup>
<col width="32%">
<col width="29%">
<col width="38%">
</colgroup>
<thead><tr class="header">
<th>Parameter</th>
<th>Location</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>threshold</code></td>
<td>
<code><a href="../reference/create_template.html">create_template()</a></code> / <code><a href="../reference/detect_template.html">detect_template()</a></code>
</td>
<td>Minimum correlation score. Adjust in <code><a href="../reference/detect_template.html">detect_template()</a></code>
to refine without recreating template.</td>
</tr>
<tr class="even">
<td><code>proximity_window</code></td>
<td><code><a href="../reference/detect_template.html">detect_template()</a></code></td>
<td>Filter duplicate detections within this time window (seconds).</td>
</tr>
<tr class="odd">
<td><code>balanced</code></td>
<td>
<code><a href="../reference/analyze_spectral.html">analyze_spectral()</a></code> / <code><a href="../reference/plot_heatmap.html">plot_heatmap()</a></code>
</td>
<td>Balance samples across time points.</td>
</tr>
</tbody>
</table>
</div>
<div class="section level2">
<h2 id="tips-for-longitudinal-analysis">Tips for Longitudinal Analysis<a class="anchor" aria-label="anchor" href="#tips-for-longitudinal-analysis"></a>
</h2>
<ol style="list-style-type: decimal">
<li><p><strong>Optimize parameters first</strong>: Use the single-file
workflow in <a href="motif_detection.html">Motif Detection</a> before
bulk processing.</p></li>
<li><p><strong>Check detection quality</strong>: Visualize sample
detections from each time point to verify template works across
developmental stages.</p></li>
<li><p><strong>Adjust threshold if needed</strong>: If detection rates
vary significantly across time points, consider adjusting the threshold
in <code><a href="../reference/detect_template.html">detect_template()</a></code>.</p></li>
<li><p><strong>Use balanced sampling</strong>: When comparing across
time points, use <code>balanced = TRUE</code> to ensure equal
representation.</p></li>
</ol>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html" class="external-link">sessionInfo</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; R version 4.5.2 (2025-10-31)</span></span>
<span><span class="co">#&gt; Platform: x86_64-pc-linux-gnu</span></span>
<span><span class="co">#&gt; Running under: Ubuntu 24.04.3 LTS</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Matrix products: default</span></span>
<span><span class="co">#&gt; BLAS:   /usr/lib/x86_64-linux-gnu/openblas-pthread/libblas.so.3 </span></span>
<span><span class="co">#&gt; LAPACK: /usr/lib/x86_64-linux-gnu/openblas-pthread/libopenblasp-r0.3.26.so;  LAPACK version 3.12.0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; locale:</span></span>
<span><span class="co">#&gt;  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       </span></span>
<span><span class="co">#&gt;  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   </span></span>
<span><span class="co">#&gt;  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          </span></span>
<span><span class="co">#&gt; [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; time zone: UTC</span></span>
<span><span class="co">#&gt; tzcode source: system (glibc)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; attached base packages:</span></span>
<span><span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span><span class="co">#&gt;  [1] digest_0.6.39     desc_1.4.3        R6_2.6.1          fastmap_1.2.0    </span></span>
<span><span class="co">#&gt;  [5] xfun_0.56         cachem_1.1.0      knitr_1.51        htmltools_0.5.9  </span></span>
<span><span class="co">#&gt;  [9] rmarkdown_2.30    lifecycle_1.0.5   cli_3.6.5         sass_0.4.10      </span></span>
<span><span class="co">#&gt; [13] pkgdown_2.2.0     textshaping_1.0.4 jquerylib_0.1.4   systemfonts_1.3.1</span></span>
<span><span class="co">#&gt; [17] compiler_4.5.2    tools_4.5.2       ragg_1.5.0        evaluate_1.0.5   </span></span>
<span><span class="co">#&gt; [21] bslib_0.10.0      yaml_2.3.12       jsonlite_2.0.0    rlang_1.1.7      </span></span>
<span><span class="co">#&gt; [25] fs_1.6.6</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Lei Xiao.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
